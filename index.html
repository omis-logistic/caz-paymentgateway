<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* Loading Screen */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #D4AF37;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Main Styles */
        :root {
            --gold: #D4AF37;
            --white: #FFFFFF;
            --text-dark: #333333;
        }

        * {
            box-sizing: border-box;
            -webkit-text-size-adjust: none;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--white);
            color: var(--text-dark);
            font-size: 14px;
            line-height: 1.4;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            display: none; /* Hidden initially */
        }

        .header {
            background: var(--gold);
            padding: 15px;
            text-align: center;
            position: sticky;
            top: 0;
        }

        .content {
            padding: 20px;
        }

        .account-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        #accNum {
            flex: 1;
            padding: 12px;
            background: #FFFBE6;
            border: 1px solid var(--gold);
            border-radius: 4px;
            word-break: break-all;
        }

        .copy-btn, input[type="submit"] {
            background: var(--gold);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }

        input[type="file"] {
            width: 100%;
            padding: 12px;
            margin: 20px 0;
            border: 2px dashed var(--gold);
            background: #FFFBE6;
            border-radius: 4px;
        }

        @media (min-width: 768px) {
            body {
                padding: 20px;
                background: #f0f0f0;
            }
            .container {
                border-radius: 10px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            }
            .copy-btn {
                width: auto;
            }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="loading-spinner"></div>
        <p>Loading Order Details...</p>
    </div>

    <div class="container">
      <div class="header">
        <h1>Payment Gateway</h1>
      </div>
      
      <div class="content">
        <p><strong>Order Number:</strong> <span id="displayOrderNumber"></span></p>
        <p><strong>Code:</strong> <span id="displayCode"></span></p>
        <p><strong>Name:</strong> <span id="displayName"></span></p>
        <p><strong>Price:</strong> $<span id="displayPrice"></span></p>
        
        <hr>
        
        <h3>Payment Instructions</h3>
        <p style="color: var(--gold); font-weight: bold;">BIBD Transfer</p>
        <div class="account-row">
          <span id="accNum">00010010016466</span>
          <button class="copy-btn" onclick="copyToClipboard()">Copy Account Number</button>
        </div>
        
        <form id="paymentForm">
          <input type="hidden" id="orderNumber" name="orderNumber">
          <input type="hidden" id="code" name="code">
          <input type="hidden" id="name" name="name">
          <input type="hidden" id="price" name="price">
          <input type="hidden" id="branchPhone" name="branchPhone">
          
          <p>Upload payment screenshot:</p>
          <input type="file" name="uploadFile" accept="image/*" required>
          <input type="submit" value="Submit Payment">
        </form>
      </div>
    </div>

    <script>
      // Replace with your deployed Apps Script URL
      const SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';

      // Initialize on load
      (async function init() {
        const urlParams = new URLSearchParams(window.location.search);
        const orderNumber = urlParams.get('orderNumber');
        
        if (!orderNumber) {
          showError('Order number required in URL parameters');
          return;
        }

        try {
          const response = await fetch(`${SCRIPT_URL}?orderNumber=${orderNumber}`);
          const data = await response.json();
          
          if (!data.success) throw new Error(data.error);
          
          document.getElementById('displayOrderNumber').textContent = orderNumber;
          document.getElementById('displayCode').textContent = data.data.code;
          document.getElementById('displayName').textContent = data.data.name;
          document.getElementById('displayPrice').textContent = data.data.price;
          
          document.getElementById('orderNumber').value = orderNumber;
          document.getElementById('code').value = data.data.code;
          document.getElementById('name').value = data.data.name;
          document.getElementById('price').value = data.data.price;
          document.getElementById('branchPhone').value = data.data.branchPhone;

        } catch (error) {
          showError(error.message);
        }
      })();

      function copyToClipboard() {
        navigator.clipboard.writeText(document.getElementById('accNum').innerText)
          .then(() => alert('Account number copied!'))
          .catch(() => alert('Failed to copy!'));
      }

      async function handleFormSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const file = formData.get('uploadFile');
        
        if (!file) {
          alert('Please select a payment screenshot!');
          return;
        }

        showLoadingState();

        try {
          const base64Data = await readFileAsBase64(file);
          const payload = {
            orderNumber: document.getElementById('orderNumber').value,
            code: document.getElementById('code').value,
            name: document.getElementById('name').value,
            price: document.getElementById('price').value,
            branchPhone: document.getElementById('branchPhone').value,
            upload: {
              name: file.name,
              data: base64Data,
              contentType: file.type
            }
          };

          const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: { 'Content-Type': 'application/json' }
          });
          
          const result = await response.json();
          if (!result.success) throw new Error(result.error);
          
          showSuccessScreen(result);

        } catch (error) {
          showError(error.message);
          restoreForm();
        }
      }

      function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      function showLoadingState() {
        document.body.innerHTML = `
          <div class="container">
            <div class="header">
              <h1>Processing Payment</h1>
            </div>
            <div class="content">
              <p>Please wait while we process your payment...</p>
            </div>
          </div>`;
      }

      function showSuccessScreen(data) {
        const message = `Payment Confirmation
Order Number: ${data.orderNumber}
Code: ${data.code}
Name: ${data.name}
Price: $${data.price}
Receipt: ${data.url}`;

        document.body.innerHTML = `
          <div class="container">
            <div class="header">
              <h1>Payment Confirmed</h1>
            </div>
            <div class="content">
              <p><strong>Order Number:</strong> ${data.orderNumber}</p>
              <p><strong>Code:</strong> ${data.code}</p>
              <p><strong>Name:</strong> ${data.name}</p>
              <p><strong>Price:</strong> $${data.price}</p>
              <p><strong>Screenshot:</strong> <a href="${data.url}" target="_blank">View Receipt</a></p>
              <button onclick="window.open('https://wa.me/${data.branchPhone}?text=${encodeURIComponent(message)}', '_blank')" 
                class="copy-btn">
                Send via WhatsApp
              </button>
            </div>
          </div>`;
      }

      function showError(message) {
        document.body.innerHTML = `
          <div class="container">
            <div class="header">
              <h1>⚠️ Error</h1>
            </div>
            <div class="content">
              <p>${message}</p>
              <p>Please contact support with your order number</p>
            </div>
          </div>`;
      }

      function restoreForm() {
        window.location.reload();
      }

      // Event listeners
      document.getElementById('paymentForm').addEventListener('submit', handleFormSubmit);
    </script>
  </body>
</html>
