<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
      /* ===== BANNER REMOVAL ===== */
      /* Hide the banner and its container */
      #ss-banding-table,
      .ss-branding-container,
      .ss-logo-container,
      #warning-bar-table {
        display: none !important;
        height: 0 !important;
        visibility: hidden !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      /* Compensate for the banner's height */
      body {
        margin-top: -40px !important;
        height: calc(100vh + 40px) !important;
        overflow: visible !important;
      }

      /* ===== ORIGINAL STYLES ===== */
      :root {
        --gold: #D4AF37;
        --white: #FFFFFF;
        --text-dark: #333333;
      }

      * {
        box-sizing: border-box;
        -webkit-text-size-adjust: none;
        -webkit-overflow-scrolling: touch;
      }

      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        width: 100vw;
        background: var(--white);
        color: var(--text-dark);
        font-size: 14px;
        line-height: 1.4;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      .container {
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        flex: 1;
      }

      .header {
        background: var(--gold);
        padding: 15px;
        text-align: center;
        position: sticky;
        top: 0;
        width: 100%;
      }

      .content {
        padding: 15px;
        width: 100%;
      }

      .account-row {
        display: block;
        width: 100%;
      }

      #accNum {
        display: block;
        width: 100%;
        font-size: 16px;
        word-break: break-word;
        text-align: center;
        margin: 10px 0;
        padding: 12px;
        background: #FFFBE6;
        border: 1px solid var(--gold);
        border-radius: 4px;
      }

      .copy-btn, input[type="submit"] {
        display: block;
        width: 100%;
        background: var(--gold);
        color: white;
        border: none;
        padding: 12px;
        border-radius: 4px;
        margin: 10px 0;
        font-size: 16px;
      }

      input[type="file"] {
        display: block;
        width: 100%;
        padding: 12px;
        margin: 15px 0;
        border: 2px dashed var(--gold);
        background: #FFFBE6;
        border-radius: 4px;
      }

      @media (min-width: 768px) {
        body {
          padding: 20px;
          background: #f0f0f0;
          font-size: 16px;
        }

        .container {
          width: 600px;
          border-radius: 10px;
          box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        .account-row {
          display: flex;
          gap: 15px;
          align-items: center;
        }

        #accNum {
          text-align: left;
          margin: 0;
        }

        .copy-btn {
          width: auto;
          min-width: 160px;
        }
      }
    </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Payment Gateway</h1>
    </div>
    
    <div class="content">
      <div id="orderDetails">
        <p><strong>Order Number:</strong> <span id="orderNumber"></span></p>
        <p><strong>Code:</strong> <span id="code"></span></p>
        <p><strong>Name:</strong> <span id="name"></span></p>
        <p><strong>Price:</strong> $<span id="price"></span></p>
      </div>
      
      <hr>
      
      <h3>Payment Instructions</h3>
      <p style="color: var(--gold); font-weight: bold;">BIBD Transfer</p>
      <div class="account-row">
        <span id="accNum">00010010016466</span>
        <button class="copy-btn" onclick="copyToClipboard()">Copy Account Number</button>
      </div>
      
      <form id="paymentForm">
        <input type="hidden" id="branchPhone">
        <p>Upload payment screenshot:</p>
        <input type="file" name="uploadFile" accept="image/*" required>
        <input type="submit" value="Submit Payment">
      </form>
    </div>
  </div>

<script>
  // JSONP Callback Handler
  function handleOrderData(response) {
    const container = document.querySelector('.container');
    
    if (response.error) {
      container.innerHTML = `
        <div style="padding:20px;color:#B8860B;font-family:Arial">
          <h2 style="margin-bottom:15px">⚠️ Payment Error</h2>
          <p>${response.error}</p>
          <p>Please contact support with your order number</p>
        </div>
      `;
      return;
    }

    // Populate Order Data
    document.getElementById('orderNumber').textContent = response.data.orderNumber;
    document.getElementById('code').textContent = response.data.code;
    document.getElementById('name').textContent = response.data.name;
    document.getElementById('price').textContent = response.data.price;
    document.getElementById('branchPhone').value = response.data.branchPhone;
  }

  // Initialize Order Load
  function loadOrderDetails() {
    const orderNumber = new URLSearchParams(window.location.search).get('orderNumber');
    if (!orderNumber) {
      showError('Order number is required');
      return;
    }

    const script = document.createElement('script');
    script.src = `https://script.google.com/macros/s/AKfycbzYDlCxrfhCvhBZDowNzwy3aRTpUNc6R_V9eMWXRnjpIpnCAVSBuezUiVbiv_A6tQiS/exec?orderNumber=${encodeURIComponent(orderNumber)}&callback=handleOrderData`;
    document.head.appendChild(script);
  }

  // File Upload Handler
  async function handleFormSubmit(e) {
    e.preventDefault();
    const form = e.target;
    const fileInput = form.uploadFile;
    const file = fileInput.files[0];
    
    if (!file) {
      alert('Please select a payment screenshot first!');
      return;
    }

    // Show Loading State
    const originalContent = document.body.innerHTML;
    document.body.innerHTML = `
      <div class="container">
        <div class="header">
          <h1>Processing Payment</h1>
        </div>
        <div class="content">
          <p>Please wait while we process your payment...</p>
        </div>
      </div>
    `;

    try {
      // Read File Contents
      const fileData = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      // Prepare Payload
      const payload = {
        orderNumber: document.getElementById('orderNumber').textContent,
        code: document.getElementById('code').textContent,
        name: document.getElementById('name').textContent,
        price: document.getElementById('price').textContent,
        branchPhone: document.getElementById('branchPhone').value,
        upload: {
          name: file.name,
          data: fileData.split(',')[1], // Remove base64 prefix
          contentType: file.type
        }
      };

      // Submit Payment
      const response = await fetch('https://script.google.com/macros/s/AKfycbzYDlCxrfhCvhBZDowNzwy3aRTpUNc6R_V9eMWXRnjpIpnCAVSBuezUiVbiv_A6tQiS/exec', {
        method: 'POST',
        body: JSON.stringify(payload),
        headers: { 'Content-Type': 'application/json' }
      });
      
      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.error);
      }

      // Show Confirmation
      const message = `Payment Confirmation
Order Number: ${result.orderNumber}
Code: ${result.code}
Name: ${result.name}
Price: $${result.price}
Screenshot: ${result.url}`;

      document.body.innerHTML = `
        <div class="container">
          <div class="header">
            <h1>Payment Confirmed</h1>
          </div>
          <div class="content">
            <p><strong>Order Number:</strong> ${result.orderNumber}</p>
            <p><strong>Code:</strong> ${result.code}</p>
            <p><strong>Name:</strong> ${result.name}</p>
            <p><strong>Price:</strong> $${result.price}</p>
            <p><strong>Screenshot:</strong> <a href="${result.url}" target="_blank">View Receipt</a></p>
            <button onclick="window.open('https://wa.me/${result.branchPhone}?text=${encodeURIComponent(message)}', '_blank')" 
              class="copy-btn">
              Send via WhatsApp
            </button>
          </div>
        </div>
      `;

    } catch (error) {
      document.body.innerHTML = originalContent;
      alert(`Payment Failed: ${error.message}`);
    }
  }

  // Clipboard Function
  async function copyToClipboard() {
    try {
      await navigator.clipboard.writeText(document.getElementById('accNum').innerText);
      alert('Account number copied to clipboard!');
    } catch (err) {
      alert('Failed to copy! Please manually select the text.');
    }
  }

  // Initialize Page
  document.addEventListener('DOMContentLoaded', () => {
    // Load order details on page load
    loadOrderDetails();
    
    // Attach form submit handler
    document.getElementById('paymentForm')
      .addEventListener('submit', handleFormSubmit);
  });

  // Error Display
  function showError(message) {
    document.body.innerHTML = `
      <div class="container">
        <div class="header">
          <h1>⚠️ Payment Error</h1>
        </div>
        <div class="content">
          <p>${message}</p>
          <p>Please check the URL or contact support</p>
        </div>
      </div>
    `;
  }
</script>
</body>
</html>
